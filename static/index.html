<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burner Mail Cloudflare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .sidebar { width: 16rem; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar.collapsed { width: 5rem; }
        .sidebar-text { transition: opacity 0.2s ease; white-space: nowrap; overflow: hidden; opacity: 1; }
        .sidebar.collapsed .sidebar-text { opacity: 0; pointer-events: none; display: none; }
        .sidebar.collapsed .nav-item { justify-content: center; }
        .sidebar.collapsed .nav-item i { margin-right: 0; }
        .sidebar.collapsed .logo-area { justify-content: center; padding: 0; }
        .logo-area i { transition: margin 0.3s; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen flex overflow-hidden">

    <aside id="sidebar" class="sidebar bg-slate-800 border-r border-slate-700 flex flex-col justify-between shadow-2xl relative z-40 shrink-0">
        <div class="logo-area h-16 flex items-center px-6 border-b border-slate-700 relative transition-all">
            <i class="fa-solid fa-fire text-orange-500 text-2xl shrink-0"></i>
            <span class="sidebar-text font-bold text-xl ml-3 tracking-tight">Burner<span class="text-orange-500">Mail</span></span>
            <button onclick="toggleSidebar()" class="absolute -right-3 top-6 bg-orange-600 rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-lg hover:bg-orange-500 transition border border-slate-900 z-50">
                <i class="fa-solid fa-chevron-left transition-transform duration-300" id="chevron"></i>
            </button>
        </div>
        <nav class="flex-1 py-6 space-y-2 px-3">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center p-3 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition group">
                <i class="fa-solid fa-inbox w-6 text-center text-lg shrink-0 transition-all"></i>
                <span class="sidebar-text ml-3 font-medium">Ativos</span>
            </button>
            <button onclick="switchTab('history')" id="nav-history" class="nav-item w-full flex items-center p-3 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition group">
                <i class="fa-solid fa-clock-rotate-left w-6 text-center text-lg shrink-0 transition-all"></i>
                <span class="sidebar-text ml-3 font-medium">Histórico</span>
            </button>
            <button onclick="switchTab('config')" id="nav-config" class="nav-item w-full flex items-center p-3 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition group">
                <i class="fa-solid fa-gear w-6 text-center text-lg shrink-0 transition-all"></i>
                <span class="sidebar-text ml-3 font-medium">Configurações</span>
            </button>
        </nav>
        <div class="p-4 border-t border-slate-700 text-center overflow-hidden">
            <span class="sidebar-text text-xs text-slate-500">v6.0 Pin Feature</span>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-900 w-full">
        <header class="h-16 bg-slate-800/50 backdrop-blur-md border-b border-slate-700 flex items-center px-8 justify-between shrink-0 relative z-30">
            <h2 id="page-title" class="text-lg font-bold text-white">Dashboard</h2>
            
            <div id="create-btn-area" class="relative z-50">
                <div class="flex shadow-lg rounded-lg overflow-hidden">
                    <button onclick="openCreateModal()" class="bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 px-4 flex items-center gap-2 transition text-sm border-r border-orange-700">
                        <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">Gerar Email</span>
                    </button>
                    <button onclick="toggleCreateDropdown()" class="bg-orange-600 hover:bg-orange-500 text-white px-3 transition text-sm flex items-center">
                        <i class="fa-solid fa-caret-down"></i>
                    </button>
                </div>

                <div id="create-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-slate-800 border border-slate-700 rounded-lg shadow-xl overflow-hidden z-50">
                    <button onclick="openCreateModal()" class="w-full text-left px-4 py-3 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition flex items-center gap-2">
                        <i class="fa-solid fa-dice text-orange-500"></i> Gerar Aleatório
                    </button>
                    <button onclick="openCustomModal()" class="w-full text-left px-4 py-3 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition flex items-center gap-2 border-t border-slate-700">
                        <i class="fa-solid fa-pen-to-square text-blue-500"></i> Email Personalizado
                    </button>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 relative scroll-smooth z-0">
            
            <div id="view-dashboard" class="view-section">
                <div id="active-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                <div id="empty-dashboard" class="hidden h-full flex flex-col items-center justify-center opacity-40 mt-20">
                    <i class="fa-solid fa-envelope-open-text text-6xl mb-4"></i>
                    <p class="text-xl">Nenhum email ativo.</p>
                </div>
            </div>

            <div id="view-history" class="view-section hidden">
                <div class="mb-6 flex gap-2">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-500"></i>
                        <input type="text" id="history-search" onkeyup="filterHistory()" placeholder="Buscar por email ou destino..." class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2.5 pl-10 pr-4 text-white focus:border-orange-500 outline-none">
                    </div>
                </div>

                <div class="bg-slate-800 rounded-xl overflow-hidden shadow-xl border border-slate-700">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="bg-slate-900 text-slate-400 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4">Alias</th>
                                    <th class="p-4">Encaminhado Para</th>
                                    <th class="p-4">Criado em</th>
                                    <th class="p-4 text-center">Status</th>
                                    <th class="p-4 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="history-table" class="divide-y divide-slate-700 text-sm text-slate-300"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-config" class="view-section hidden max-w-4xl mx-auto space-y-8">
                <div class="bg-slate-800 p-8 rounded-xl shadow-lg border border-slate-700">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                        <i class="fa-brands fa-cloudflare text-orange-500"></i> Credenciais Cloudflare
                    </h3>
                    <form onsubmit="saveConfig(event)" class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">API Token</label>
                            <input type="text" id="cfg-token" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-orange-400 font-mono focus:border-orange-500 outline-none" placeholder="Token mascarado..." required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Zone ID</label>
                                <input type="text" id="cfg-zone" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white focus:border-orange-500 outline-none" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Domínio</label>
                                <input type="text" id="cfg-domain" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white focus:border-orange-500 outline-none" placeholder="ex: meudominio.com" required>
                            </div>
                        </div>
                        <button type="submit" class="bg-slate-700 hover:bg-green-600 text-white font-bold py-3 rounded mt-2 transition shadow">
                            <i class="fa-solid fa-save mr-2"></i> Salvar Credenciais
                        </button>
                    </form>
                </div>

                <div class="bg-slate-800 p-8 rounded-xl shadow-lg border border-slate-700">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-users-gear text-blue-500"></i> Gerenciar Destinos
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="loadDestinations()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition border border-slate-600">
                                <i class="fa-solid fa-sync"></i>
                            </button>
                            <button onclick="openAddDestModal()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition font-bold shadow">
                                <i class="fa-solid fa-plus mr-1"></i> Adicionar
                            </button>
                        </div>
                    </div>
                    <div class="space-y-3" id="dest-list"></div>
                </div>
            </div>

        </div>
    </main>

    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <div id="create-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-md w-full p-6 relative transform transition-all scale-100">
            <button onclick="closeCreateModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-4">Gerar Novo Email</h3>
            
            <div id="create-modal-loading" class="flex flex-col items-center justify-center py-8">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl text-orange-500 mb-2"></i>
                <p class="text-slate-500 text-sm">Carregando destinos...</p>
            </div>

            <div id="create-modal-content" class="hidden">
                <p class="text-slate-400 text-sm mb-6">Escolha o destino (sincronizado do Cloudflare).</p>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Destino Real</label>
                    <select id="modal-dest-select" class="dest-select-target w-full bg-slate-900 border border-slate-600 rounded p-3 text-white outline-none focus:border-orange-500"></select>
                </div>
                <button onclick="confirmCreateEmail()" id="btn-confirm-create" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded shadow-lg transition flex justify-center items-center gap-2">
                    <i class="fa-solid fa-magic-wand-sparkles"></i> Gerar Agora
                </button>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-md w-full p-6 relative transform transition-all scale-100">
            <button onclick="closeCustomModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-2">Email Personalizado</h3>
            
            <div id="custom-modal-loading" class="flex flex-col items-center justify-center py-8">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl text-blue-500 mb-2"></i>
                <p class="text-slate-500 text-sm">Preparando...</p>
            </div>

            <div id="custom-modal-content" class="hidden">
                <p class="text-slate-400 text-sm mb-6">Crie um alias específico.</p>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Alias Desejado</label>
                        <div class="flex items-center">
                            <input type="text" id="custom-alias-input" class="flex-1 bg-slate-900 border border-r-0 border-slate-600 rounded-l p-3 text-white outline-none focus:border-blue-500" placeholder="ex: netflix-teste">
                            <span id="domain-suffix" class="bg-slate-700 border border-l-0 border-slate-600 rounded-r p-3 text-slate-300 text-sm font-mono">...</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Destino Real</label>
                        <select id="custom-dest-select" class="dest-select-target w-full bg-slate-900 border border-slate-600 rounded p-3 text-white outline-none focus:border-blue-500"></select>
                    </div>
                </div>

                <button onclick="confirmCustomEmail()" id="btn-confirm-custom" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded shadow-lg transition flex justify-center items-center gap-2">
                    <i class="fa-solid fa-check"></i> Criar Personalizado
                </button>
            </div>
        </div>
    </div>

    <div id="add-dest-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-md w-full p-6 relative">
            <button onclick="closeAddDestModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-2">Adicionar Novo Destino</h3>
            <p class="text-slate-400 text-sm mb-6">O Cloudflare enviará um email de confirmação.</p>
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Endereço de Email</label>
                <input type="email" id="new-dest-input" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white outline-none focus:border-blue-500" placeholder="voce@gmail.com">
            </div>
            <button onclick="confirmAddDest()" id="btn-confirm-add" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded shadow-lg transition flex justify-center items-center gap-2">
                <i class="fa-solid fa-paper-plane"></i> Enviar Solicitação
            </button>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-sm w-full p-6 relative transform transition-all scale-100">
            <h3 id="confirm-title" class="text-xl font-bold text-white mb-2">Confirmação</h3>
            <p id="confirm-desc" class="text-slate-400 text-sm mb-6">Tem certeza?</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 py-2 rounded-lg border border-slate-600 text-slate-300 hover:bg-slate-700 hover:text-white transition font-medium text-sm">Cancelar</button>
                <button id="btn-modal-confirm-action" class="flex-1 py-2 rounded-lg bg-orange-600 hover:bg-orange-500 text-white font-bold shadow-lg transition text-sm">Sim, Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // --- DROPDOWN LOGIC ---
        function toggleCreateDropdown() {
            const dd = document.getElementById('create-dropdown');
            dd.classList.toggle('hidden');
        }

        window.addEventListener('click', function(e) {
            const area = document.getElementById('create-btn-area');
            if (!area.contains(e.target)) {
                document.getElementById('create-dropdown').classList.add('hidden');
            }
        });

        // --- INSTANT MODAL OPEN LOGIC ---
        async function openCreateModal() {
            document.getElementById('create-dropdown').classList.add('hidden');
            document.getElementById('create-modal').classList.remove('hidden');
            document.getElementById('create-modal-loading').classList.remove('hidden');
            document.getElementById('create-modal-content').classList.add('hidden');
            await loadDestinations(); 
            document.getElementById('create-modal-loading').classList.add('hidden');
            document.getElementById('create-modal-content').classList.remove('hidden');
        }

        function closeCreateModal() {
            document.getElementById('create-modal').classList.add('hidden');
        }

        // --- CUSTOM EMAIL LOGIC ---
        async function openCustomModal() {
            document.getElementById('create-dropdown').classList.add('hidden');
            document.getElementById('custom-modal').classList.remove('hidden');
            document.getElementById('custom-modal-loading').classList.remove('hidden');
            document.getElementById('custom-modal-content').classList.add('hidden');

            const destsPromise = loadDestinations();
            const configPromise = fetch('/api/config').then(r => r.json()).then(cfg => {
                if(cfg.domain) document.getElementById('domain-suffix').innerText = '@' + cfg.domain;
            }).catch(()=>{});

            await Promise.all([destsPromise, configPromise]);

            document.getElementById('custom-modal-loading').classList.add('hidden');
            document.getElementById('custom-modal-content').classList.remove('hidden');
        }

        function closeCustomModal() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        async function confirmCustomEmail() {
            const alias = document.getElementById('custom-alias-input').value.trim();
            const dest = document.getElementById('custom-dest-select').value;
            const domainSuffix = document.getElementById('domain-suffix').innerText;
            
            if(!alias) { alert("Digite um alias."); return; }
            
            const fullEmail = alias + domainSuffix;

            const checkRes = await fetch(`/api/check?email=${fullEmail}`);
            const checkData = await checkRes.json();

            if(checkData.exists) {
                closeCustomModal();
                openConfirmModal(
                    'Email Já Existe', 
                    `O endereço ${fullEmail} já está no histórico. Deseja recriá-lo por mais 5 minutos?`,
                    () => executeRecreate(fullEmail, dest),
                    false
                );
                return;
            }

            const btn = document.getElementById('btn-confirm-custom');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Criando...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/create', { 
                    method: 'POST',
                    body: JSON.stringify({ email: fullEmail, destination: dest })
                });

                if(res.ok) {
                    showToast('Email Personalizado Criado!', 'success');
                    closeCustomModal();
                    switchTab('dashboard');
                } else {
                    const txt = await res.text();
                    showToast(txt, 'error');
                }
            } catch(e) {
                showToast('Erro de conexão', 'error');
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Criar Personalizado';
                btn.disabled = false;
            }
        }

        // --- GENERIC CONFIRMATION ---
        let pendingConfirmAction = null;

        function openConfirmModal(title, msg, actionCallback, isDestructive = false) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-desc').innerText = msg;
            pendingConfirmAction = actionCallback;

            const btn = document.getElementById('btn-modal-confirm-action');
            if(isDestructive) {
                btn.className = "flex-1 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-white font-bold shadow-lg transition text-sm";
            } else {
                btn.className = "flex-1 py-2 rounded-lg bg-orange-600 hover:bg-orange-500 text-white font-bold shadow-lg transition text-sm";
            }

            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            pendingConfirmAction = null;
        }

        document.getElementById('btn-modal-confirm-action').addEventListener('click', () => {
            if(pendingConfirmAction) pendingConfirmAction();
            closeConfirmModal();
        });

        // --- SIDEBAR & TABS ---
        let sidebarCollapsed = false;
        function toggleSidebar() {
            sidebarCollapsed = !sidebarCollapsed;
            const sidebar = document.getElementById('sidebar');
            const chevron = document.getElementById('chevron');
            if(sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                chevron.style.transform = "rotate(180deg)";
            } else {
                sidebar.classList.remove('collapsed');
                chevron.style.transform = "rotate(0deg)";
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            const titles = { 'dashboard': 'Painel de Controle', 'history': 'Histórico de Emails', 'config': 'Configurações do Sistema' };
            document.getElementById('page-title').innerText = titles[tab];
            const btnArea = document.getElementById('create-btn-area');
            if(tab === 'dashboard') btnArea.style.display = 'block'; else btnArea.style.display = 'none';
            
            document.getElementById('create-dropdown').classList.add('hidden');

            document.querySelectorAll('aside nav button').forEach(b => {
                b.classList.remove('bg-slate-700', 'text-white');
                b.classList.add('text-slate-400');
            });
            const activeBtn = document.getElementById(`nav-${tab}`);
            activeBtn.classList.add('bg-slate-700', 'text-white');
            activeBtn.classList.remove('text-slate-400');

            if(tab === 'dashboard') loadActive();
            if(tab === 'history') loadHistory();
            if(tab === 'config') { loadConfig(); loadDestinations(); }
        }

        // --- HISTORY ---
        async function loadHistory() {
            const res = await fetch('/api/history');
            const list = await res.json();
            const tbody = document.getElementById('history-table');
            tbody.innerHTML = '';
            
            list.forEach(item => {
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-800/50 transition border-b border-slate-700/50 last:border-0 history-row";
                
                const statusHtml = item.active 
                    ? '<span class="inline-flex items-center gap-1 bg-green-500/20 text-green-400 px-2 py-0.5 rounded text-xs border border-green-500/30"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>ATIVO</span>'
                    : '<span class="inline-flex items-center gap-1 bg-slate-700 text-slate-400 px-2 py-0.5 rounded text-xs">EXPIRADO</span>';

                let actionBtn = '';
                if(!item.active) {
                    actionBtn = `
                        <button onclick="confirmRecreate('${item.email}', '${item.destination}')" class="text-orange-500 hover:text-white hover:bg-orange-600 px-3 py-1.5 rounded transition text-xs font-bold flex items-center gap-1 ml-auto border border-orange-500/30 hover:border-orange-500">
                            <i class="fa-solid fa-rotate-right"></i> Recriar
                        </button>`;
                }

                row.innerHTML = `
                    <td class="p-4 font-mono text-white select-all alias-cell">${item.email}</td>
                    <td class="p-4 text-slate-400 text-xs dest-cell">${item.destination}</td>
                    <td class="p-4 text-slate-500">${new Date(item.created_at).toLocaleString()}</td>
                    <td class="p-4 text-center">${statusHtml}</td>
                    <td class="p-4 text-right">${actionBtn}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterHistory() {
            const term = document.getElementById('history-search').value.toLowerCase();
            const rows = document.querySelectorAll('.history-row');
            rows.forEach(row => {
                const alias = row.querySelector('.alias-cell').innerText.toLowerCase();
                const dest = row.querySelector('.dest-cell').innerText.toLowerCase();
                if(alias.includes(term) || dest.includes(term)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function confirmRecreate(email, destination) {
            openConfirmModal(
                'Recriar Email', 
                `Deseja reativar o endereço ${email} por mais 5 minutos?`, 
                () => executeRecreate(email, destination), 
                false
            );
        }

        async function executeRecreate(email, destination) {
            showToast('Recriando...', 'success');
            try {
                const res = await fetch('/api/create', { 
                    method: 'POST',
                    body: JSON.stringify({ email: email, destination: destination })
                });

                if(res.ok) {
                    showToast('Email Recriado!', 'success');
                    switchTab('dashboard'); 
                } else {
                    const txt = await res.text();
                    showToast(txt, 'error');
                }
            } catch(e) {
                showToast('Erro de conexão', 'error');
            }
        }

        // --- DELETIONS ---
        function confirmDeleteEmail(id) {
            openConfirmModal(
                'Destruir Email', 
                'Isso removerá o redirecionamento imediatamente. Tem certeza?', 
                () => executeDeleteEmail(id), 
                true
            );
        }

        async function executeDeleteEmail(id) {
            await fetch(`/api/delete?id=${id}`, { method: 'DELETE' });
            loadActive();
            showToast('Email destruído.', 'success');
        }

        function confirmDeleteDest(id) {
            openConfirmModal(
                'Remover Destino', 
                'Tem certeza que deseja remover este email da sua conta Cloudflare?', 
                () => executeDeleteDest(id), 
                true
            );
        }

        async function executeDeleteDest(id) {
            try {
                const res = await fetch(`/api/destinations?id=${id}`, { method: 'DELETE' });
                if(res.ok) {
                    showToast('Destino removido.', 'success');
                    loadDestinations();
                } else {
                    showToast('Erro ao remover.', 'error');
                }
            } catch(e) { showToast('Erro de conexão', 'error'); }
        }

        // --- TOGGLE PIN LOGIC ---
        function confirmPin(id, isCurrentlyPinned) {
            const action = isCurrentlyPinned ? "Desafixar" : "Fixar";
            const msg = isCurrentlyPinned 
                ? "Ao desafixar, o email expirará em 5 minutos. Deseja continuar?"
                : "Ao fixar, o email NÃO expirará automaticamente. Deseja continuar?";
            
            openConfirmModal(
                `${action} Email`, 
                msg, 
                () => executePin(id, !isCurrentlyPinned), 
                false // Not typically dangerous
            );
        }

        async function executePin(id, newState) {
            try {
                const res = await fetch('/api/pin', {
                    method: 'POST',
                    body: JSON.stringify({ id: id, pinned: newState })
                });

                if(res.ok) {
                    showToast(newState ? 'Email Fixado!' : 'Email Desafixado (5 min restantes)', 'success');
                    loadActive();
                } else {
                    showToast('Erro ao alterar status', 'error');
                }
            } catch(e) {
                showToast('Erro de conexão', 'error');
            }
        }

        // --- STANDARD LOGIC ---
        async function loadDestinations() {
            const container = document.getElementById('dest-list');
            if(document.getElementById('view-config').classList.contains('hidden') === false) {
                container.innerHTML = '<div class="text-slate-500 text-sm animate-pulse">Sincronizando...</div>';
            }

            try {
                const res = await fetch('/api/destinations');
                if(!res.ok) {
                    const err = await res.text();
                    container.innerHTML = `<div class="text-red-400 text-sm bg-red-900/20 p-3 rounded border border-red-900/50"><i class="fa-solid fa-circle-exclamation mr-2"></i>${err}</div>`;
                    return;
                }

                const list = await res.json();
                
                container.innerHTML = '';
                if(!list || list.length === 0) {
                    container.innerHTML = '<p class="text-slate-500 italic text-sm">Nenhum email encontrado.</p>';
                } else {
                    list.forEach(d => {
                        const isVerified = !!d.verified;
                        const statusBadge = isVerified 
                            ? `<span class="text-xs bg-green-500/10 text-green-400 border border-green-500/20 px-2 py-0.5 rounded font-bold uppercase tracking-wider">Verificado</span>`
                            : `<span class="text-xs bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 px-2 py-0.5 rounded font-bold uppercase tracking-wider">Pendente</span>`;
                        const iconClass = isVerified ? "fa-check-circle text-green-500" : "fa-clock text-yellow-500";
                        const opacityClass = isVerified ? "" : "opacity-75";

                        const item = document.createElement('div');
                        item.className = 'flex items-center justify-between bg-slate-900 p-3 rounded border border-slate-700 transition hover:border-slate-600';
                        item.innerHTML = `
                            <div class="flex items-center gap-3 ${opacityClass}">
                                <i class="fa-solid ${iconClass}"></i>
                                <div>
                                    <div class="text-slate-200 font-medium">${d.email}</div>
                                    <div class="text-xs text-slate-500">${statusBadge}</div>
                                </div>
                            </div>
                            <button onclick="confirmDeleteDest('${d.tag}')" class="text-slate-600 hover:text-red-500 px-3 py-2 transition rounded hover:bg-red-500/10">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        `;
                        container.appendChild(item);
                    });
                }

                const selects = document.querySelectorAll('.dest-select-target');
                selects.forEach(sel => {
                    sel.innerHTML = '';
                    list.forEach(d => {
                        const isVerified = !!d.verified;
                        const opt = document.createElement('option');
                        opt.value = d.email;
                        opt.innerText = isVerified ? d.email : `${d.email} (Pendente)`;
                        if(!isVerified) opt.disabled = true; 
                        sel.appendChild(opt);
                    });
                });

            } catch(e) {
                container.innerHTML = '<div class="text-red-400 text-sm">Erro de conexão.</div>';
            }
        }

        function openAddDestModal() { document.getElementById('add-dest-modal').classList.remove('hidden'); }
        function closeAddDestModal() { document.getElementById('add-dest-modal').classList.add('hidden'); }

        async function confirmAddDest() {
            const input = document.getElementById('new-dest-input');
            const email = input.value;
            const btn = document.getElementById('btn-confirm-add');

            if(!email) return;

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processando...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/destinations', {
                    method: 'POST',
                    body: JSON.stringify({ email: email })
                });

                if(res.ok) {
                    showToast('Email adicionado! Verifique sua caixa de entrada.', 'success');
                    input.value = '';
                    closeAddDestModal();
                    loadDestinations();
                } else {
                    const txt = await res.text();
                    showToast(txt, 'error');
                }
            } catch(e) {
                showToast('Erro de conexão', 'error');
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Enviar Solicitação';
                btn.disabled = false;
            }
        }

        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const data = await res.json();
                if(data.cf_token) {
                    document.getElementById('cfg-token').value = data.cf_token;
                    document.getElementById('cfg-zone').value = data.zone_id;
                    document.getElementById('cfg-domain').value = data.domain;
                }
            } catch(e) {}
        }

        async function saveConfig(e) {
            e.preventDefault();
            const data = {
                cf_token: document.getElementById('cfg-token').value,
                zone_id: document.getElementById('cfg-zone').value,
                domain: document.getElementById('cfg-domain').value
            };
            const res = await fetch('/api/config', { method: 'POST', body: JSON.stringify(data) });
            if(res.ok) {
                showToast('Credenciais Salvas!', 'success');
                loadDestinations();
            }
        }

        async function confirmCreateEmail() {
            const dest = document.getElementById('modal-dest-select').value;
            if(!dest) { alert("Selecione um destino válido."); return; }
            const btn = document.getElementById('btn-confirm-create');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Criando...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/create', { 
                    method: 'POST',
                    body: JSON.stringify({ destination: dest })
                });

                if(res.ok) {
                    closeCreateModal();
                    loadActive();
                    showToast('Email Criado com Sucesso!', 'success');
                } else {
                    const txt = await res.text();
                    showToast(txt, 'error');
                }
            } catch(e) {
                showToast('Erro de conexão', 'error');
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-magic-wand-sparkles"></i> Gerar Agora';
                btn.disabled = false;
            }
        }

        async function loadActive() {
            const res = await fetch('/api/active');
            const list = await res.json();
            const grid = document.getElementById('active-grid');
            grid.innerHTML = '';
            if(!list || list.length === 0) {
                document.getElementById('empty-dashboard').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-dashboard').classList.add('hidden');
            list.forEach(item => {
                const created = new Date(item.created_at);
                const expires = new Date(created.getTime() + 5*60000); 
                
                // Pin logic styling
                const isPinned = item.pinned;
                const borderClass = isPinned ? 'border-green-500/50' : 'border-slate-700';
                const pinBtnColor = isPinned ? 'text-green-400 bg-green-500/10 border-green-500/30' : 'text-slate-400 hover:text-white hover:bg-slate-700';
                const timerDisplay = isPinned ? '<i class="fa-solid fa-infinity"></i>' : '--:--';
                const progressWidth = isPinned ? '100%' : '0%';
                const progressColor = isPinned ? 'bg-green-500' : 'bg-gradient-to-r from-orange-500 to-red-500';

                const card = document.createElement('div');
                card.className = `bg-slate-800 border ${borderClass} rounded-xl p-5 relative overflow-hidden group hover:border-orange-500/50 transition shadow-lg`;
                
                card.innerHTML = `
                    <div class="absolute top-0 left-0 h-1 ${progressColor} w-full transition-all duration-1000" id="prog-${item.id}" style="width: ${progressWidth}"></div>
                    
                    <div class="flex justify-between items-start mb-4">
                        <div class="text-xs text-slate-400 font-mono flex items-center gap-1 max-w-[65%] truncate" title="${item.destination}">
                            <i class="fa-solid fa-arrow-right-long text-slate-600"></i> ${item.destination}
                        </div>
                        <span id="timer-${item.id}" class="font-mono font-bold text-white bg-slate-900 px-2 py-1 rounded text-sm">${timerDisplay}</span>
                    </div>

                    <div class="mb-5 text-center">
                        <code class="text-lg text-white font-bold cursor-pointer hover:text-orange-400 transition break-all select-all" onclick="copyText('${item.email}')">
                            ${item.email}
                        </code>
                        <p class="text-xs text-slate-500 mt-1">Clique para copiar</p>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="confirmPin('${item.id}', ${isPinned})" class="flex-1 ${pinBtnColor} border border-transparent py-2 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2" title="${isPinned ? 'Desafixar' : 'Fixar para não expirar'}">
                            <i class="fa-solid fa-thumbtack ${isPinned ? '' : 'rotate-45'}"></i>
                        </button>
                        <button onclick="confirmDeleteEmail('${item.id}')" class="flex-[3] bg-slate-700 hover:bg-red-600 text-slate-300 hover:text-white py-2 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-trash"></i> Destruir
                        </button>
                    </div>
                `;
                grid.appendChild(card);
                
                if(!isPinned) {
                    startLocalTimer(item.id, expires);
                }
            });
        }

        function startLocalTimer(id, expires) {
            const el = document.getElementById(`timer-${id}`);
            const prog = document.getElementById(`prog-${id}`);
            if(!el) return;
            if(window[`timer_${id}`]) clearInterval(window[`timer_${id}`]);
            window[`timer_${id}`] = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((expires - now)/1000);
                const total = 300; 
                if(diff <= 0) {
                    clearInterval(window[`timer_${id}`]);
                    el.innerText = "00:00";
                    prog.style.width = "0%";
                    loadActive();
                } else {
                    const m = Math.floor(diff/60);
                    const s = diff%60;
                    el.innerText = `${m}:${s.toString().padStart(2,'0')}`;
                    prog.style.width = `${(diff/total)*100}%`;
                }
            }, 1000);
        }

        function copyText(txt) {
            navigator.clipboard.writeText(txt);
            showToast('Endereço copiado!', 'success');
        }

        function showToast(msg, type) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            const color = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            t.className = `${color} text-white px-4 py-3 rounded shadow-lg pointer-events-auto flex items-center gap-3 transform transition-all translate-x-0`;
            t.innerHTML = `<i class="fa-solid ${type==='success'?'fa-check':'fa-triangle-exclamation'}"></i> <span>${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translateY(-10px)';
                setTimeout(() => t.remove(), 300);
            }, 3000);
        }

        switchTab('dashboard');
    </script>
</body>
</html>