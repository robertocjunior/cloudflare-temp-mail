<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare Temp Mail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Animação do Toast */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-8 relative">

    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-3 pointer-events-none">
        </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-slate-800 border border-slate-700 p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300" id="modal-content">
            <h3 class="text-xl font-bold text-white mb-2"><i class="fa-solid fa-triangle-exclamation text-orange-500 mr-2"></i>Confirmar Exclusão</h3>
            <p class="text-slate-400 mb-6">Tem certeza que deseja destruir este email imediatamente? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 transition">Cancelar</button>
                <button id="btn-confirm-delete" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-white font-semibold shadow-lg transition">Sim, Destruir</button>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-500">
                    <i class="fa-solid fa-fire-flame-curved mr-2"></i>Burner Mail
                </h1>
                <p class="text-slate-400 text-sm mt-1">Gerenciador de Aliases Cloudflare</p>
            </div>
            <button onclick="createEmail()" id="btn-create" class="bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-105 flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> Gerar Novo Email
            </button>
        </div>

        <div id="email-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>

        <div id="empty-state" class="hidden text-center py-20 opacity-50">
            <i class="fa-regular fa-envelope-open text-6xl mb-4"></i>
            <p class="text-xl">Nenhum email ativo no momento.</p>
        </div>
    </div>

    <script>
        // --- LÓGICA DE NOTIFICAÇÕES (TOAST) ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            
            // Cria o elemento
            const toast = document.createElement('div');
            const icon = type === 'success' ? '<i class="fa-solid fa-circle-check"></i>' : '<i class="fa-solid fa-circle-info"></i>';
            const colorClass = type === 'success' ? 'border-l-green-500 text-green-400' : 'border-l-blue-500 text-blue-400';
            
            toast.className = `bg-slate-800 border-l-4 ${colorClass} text-white px-4 py-3 rounded shadow-lg flex items-center gap-3 min-w-[300px] toast-enter pointer-events-auto`;
            toast.innerHTML = `
                <div class="text-lg">${icon}</div>
                <div>
                    <p class="font-bold text-sm text-gray-100">Notificação</p>
                    <p class="text-xs text-gray-400">${message}</p>
                </div>
            `;

            container.appendChild(toast);

            // Remove após 3 segundos
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.5s ease';
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        // --- LÓGICA DO MODAL ---
        let emailIdToDelete = null;

        function openDeleteModal(id) {
            emailIdToDelete = id;
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('modal-content');
            
            modal.classList.remove('hidden');
            // Timeout pequeno para permitir a transição CSS funcionar
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('modal-content');
            
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                emailIdToDelete = null;
            }, 300);
        }

        document.getElementById('btn-confirm-delete').addEventListener('click', async () => {
            if (emailIdToDelete) {
                await executeDelete(emailIdToDelete);
                closeModal();
            }
        });

        // --- LÓGICA PRINCIPAL ---

        document.addEventListener('DOMContentLoaded', loadEmails);

        async function loadEmails() {
            try {
                const res = await fetch('/api/list');
                const emails = await res.json();
                renderEmails(emails);
            } catch (error) {
                console.error("Erro ao carregar", error);
            }
        }

        async function createEmail() {
            const btn = document.getElementById('btn-create');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Criando...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/create', { method: 'POST' });
                if(res.ok) {
                    showToast('Email temporário criado com sucesso!', 'success');
                    await loadEmails();
                } else {
                    showToast('Erro ao criar email.', 'error');
                }
            } catch(e) {
                showToast('Erro de conexão.', 'error');
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-plus"></i> Gerar Novo Email';
                btn.disabled = false;
            }
        }

        async function executeDelete(id) {
            // UI Otimista
            const card = document.getElementById(`card-${id}`);
            if(card) card.style.opacity = '0.5';
            
            try {
                await fetch(`/api/delete?id=${id}`, { method: 'DELETE' });
                showToast('Email excluído com sucesso.', 'success');
                await loadEmails();
            } catch (e) {
                showToast('Falha ao excluir email.', 'error');
                if(card) card.style.opacity = '1';
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showToast('Endereço copiado para a área de transferência!', 'success');
        }

        function renderEmails(emails) {
            const grid = document.getElementById('email-grid');
            const empty = document.getElementById('empty-state');
            
            grid.innerHTML = '';
            
            if (!emails || emails.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            emails.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            emails.forEach(email => {
                const card = document.createElement('div');
                card.id = `card-${email.id}`;
                card.className = "bg-slate-800 border border-slate-700 rounded-xl p-6 shadow-xl relative overflow-hidden group hover:border-orange-500/50 transition-colors";
                
                const expires = new Date(email.expires_at).getTime();
                const now = new Date().getTime();
                const timeLeft = Math.max(0, Math.floor((expires - now) / 1000));
                
                // Calcula porcentagem para a barra de progresso (baseado em 5 min = 300s)
                const progressPct = (timeLeft / 300) * 100;

                card.innerHTML = `
                    <div class="absolute top-0 left-0 w-full h-1 bg-slate-700">
                        <div class="h-full bg-orange-500 transition-all duration-1000" style="width: ${progressPct}%"></div>
                    </div>
                    
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-orange-500/10 text-orange-400 text-xs font-mono py-1 px-2 rounded border border-orange-500/20">
                            AUTO-DESTRUCT
                        </div>
                        <span id="timer-${email.id}" class="font-mono font-bold text-slate-300">${formatTime(timeLeft)}</span>
                    </div>

                    <div class="mb-6">
                        <p class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Seu Endereço Temporário</p>
                        <div class="flex items-center gap-2 group-hover:text-white transition-colors">
                            <code class="text-lg text-slate-200 font-medium truncate">${email.email}</code>
                            <button onclick="copyToClipboard('${email.email}')" class="text-slate-500 hover:text-orange-400 transition p-1">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <button onclick="openDeleteModal('${email.id}')" class="w-full bg-slate-700 hover:bg-red-600/90 text-slate-300 hover:text-white py-2 rounded-lg transition-colors text-sm font-semibold flex items-center justify-center gap-2">
                        <i class="fa-solid fa-trash-can"></i> Deletar Agora
                    </button>
                `;
                grid.appendChild(card);
                startCardTimer(email.id, expires);
            });
        }

        function startCardTimer(id, expiresTime) {
            const el = document.getElementById(`timer-${id}`);
            if (!el) return;

            // Limpa intervalo anterior se houver (para evitar duplicidade em re-render)
            if (window[`timer_interval_${id}`]) clearInterval(window[`timer_interval_${id}`]);

            window[`timer_interval_${id}`] = setInterval(() => {
                const now = new Date().getTime();
                const diff = Math.floor((expiresTime - now) / 1000);

                if (diff <= 0) {
                    clearInterval(window[`timer_interval_${id}`]);
                    el.innerText = "Expirado";
                    loadEmails(); 
                } else {
                    el.innerText = formatTime(diff);
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }
    </script>
</body>
</html>